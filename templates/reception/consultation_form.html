{% extends "reception/base.html" %}
{% block title %}{% if form.instance.pk %}Editar Consulta{% else %}Agendar Consulta{% endif %}{% endblock %}
{% block page_title %}Agendamiento - Nueva consulta{% endblock page_title %}
{% load form_tags_reception %}
{% block content %}
<main>
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow-lg border-0">
                    <div class="card-header text-white d-flex align-items-center ">
                        <h4 class="mb-0 text-dark">{% if form.instance.pk %}Editar Consulta{% else %}Agendar Consulta{% endif %}</h4>
                    </div>
                    <div class="card-body">
                        <!-- Formulario de búsqueda de paciente por CI -->
                        <form method="get" class="mb-4">
                            <div class="input-group mb-2">
                                <input type="text" name="ci_query" class="form-control" placeholder="Número de Cédula de Identidad" value="{{ ci_query|default:'' }}">
                                <button class="btn btn-outline-secondary" type="submit">
                                    <i class="bi bi-search"></i> Buscar
                                </button>
                            </div>
                            <small class="text-muted">Busque al paciente por número de Cédula de Identidad</small>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-dark">Especialidad</label>
                                    <select name="especialidad" class="form-select" onchange="this.form.submit()">
                                        <option value="">Seleccione una especialidad</option>
                                        {% for esp in especialidades %}
                                            <option value="{{ esp.id }}" {% if esp.id|stringformat:"s" == especialidad_id %}selected{% endif %}>{{ esp.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </form>
                        {% if paciente_encontrado %}
                            
                        {% elif ci_query %}
                            <div class="alert alert-danger">
                                No se encontró ningún paciente con ese número de CI.
                            </div>
                        {% endif %}

<!--  -->
                        {% if form.errors %}
                            <div class="alert alert-danger">
                                <ul>
                                {% for field in form %}
                                    {% for error in field.errors %}
                                        <li>{{ field.label }}: {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
<!--  -->

                        <form method="post" class="needs-validation" novalidate>
                            {% csrf_token %}
                            {{ form.non_field_errors }}

                            <!-- Paciente: solo muestra el paciente encontrado -->
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-dark">Paciente</label>
                                    {% if paciente_encontrado %}
                                        <input type="text" class="form-control" value="{{ paciente_encontrado.full_name }} (CI: {{ paciente_encontrado.identification_number }})" readonly>
                                        <input type="hidden" name="patient" value="{{ paciente_encontrado.id }}">
                                    {% else %}
                                        <input type="text" class="form-control" value="" placeholder="Busque y seleccione un paciente" readonly>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-dark">Doctor</label>
                                    {{ form.doctor|add_class:"form-select" }}
                                    {% if form.doctor.errors %}
                                        <div class="text-danger small">{{ form.doctor.errors|striptags }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row g-3 mb-4">
                                <div class="col-md-6 mb-2">
                                    <label class="form-label fw-bold text-dark">Días de atención del doctor</label>
                                    <div id="diasDoctor" class="alert alert-info py-2 px-3" style="min-height:38px;">
                                        Seleccione un doctor para ver los días de atención.
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label fw-bold text-dark">Fecha</label>
                                    <input type="date" id="id_date" name="date" class="form-control" required value="{% if form.instance.pk %}{{ form.instance.date|date:'Y-m-d' }}{% endif %}">
                                    <button type="button" class="btn btn-info mt-2" onclick="verHorariosDoctor()">Ver horarios</button>
                                </div>
                                
                            </div>
                            
                            <div class="row g-3 mb-4">
                               
                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-dark">Horario seleccionado</label>
                                    <div id="horarioSeleccionadoInfo" class="alert alert-info py-2 px-3" style="min-height:38px;">
                                        <!-- Aquí se mostrará el horario seleccionado -->
                                    </div>
                                </div>

                                 <div class="col-md-2">
                                    <label class="form-label fw-bold text-dark">Turno</label>
                                    {{ form.shift|add_class:"form-select" }}
                                    {% if form.shift.errors %}
                                        <div class="text-danger small">{{ form.shift.errors|striptags }}</div>
                                    {% endif %}
                                </div>

<!-- 
                                <div class="col-md-2">
                                    <label class="form-label fw-bold text-dark">Estado</label>
                                    {{ form.status|add_class:"form-select" }}
                                    {% if form.status.errors %}
                                        <div class="text-danger small">{{ form.status.errors|striptags }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-2">
                                    <label class="form-label fw-bold text-dark">Turno</label>
                                    
                                    <input type="hidden" name="shift" value="{{ form.shift.value }}">
                                  
                                    <div class="alert alert-info py-2 px-3">
                                        {{ form.shift.value|default:"(no asignado)" }}
                                    </div>
                                </div> -->

                                <div class="col-md-3">
                                    <label class="form-label text-dark">Estado</label>
                                    <input type="hidden" name="status" value="{{ form.status.value }}">
                                    <div class="alert alert-info py-2 px-3">
                                        {{ form.status.value|default:"EN ESPERA" }}
                                    </div>
                                </div>
                            </div>

                            {% if form.cleaned_data.doctor and form.cleaned_data.date and form.cleaned_data.time %}
                                {% with doctor=form.cleaned_data.doctor date=form.cleaned_data.date time=form.cleaned_data.time %}
                                    {% comment %} 
                                    {{ consultorio_asignado }}
                                    {% endcomment %}
                                    <div class="mb-3">
                                        <label class="form-label">Consultorio asignado</label>
                                        <input type="text" class="form-control" value="{{ consultorio_asignado }}" readonly>
                                    </div>
                                {% endwith %}
                            {% endif %}
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold text-dark">Motivo de la consulta</label>
                                {{ form.description|add_attrs:"class=form-control,rows=3,placeholder=Motivo de la consulta" }}
                                {% if form.description.errors %}
                                    <div class="text-danger small">{{ form.description.errors|striptags }}</div>
                                {% endif %}
                            </div>

                            <input type="hidden" id="turno_auto" name="turno_auto">
                            <input type="hidden" id="hora_consulta" name="time">
                            {% if form.instance.pk %}
                              <input type="hidden" id="consulta_id" value="{{ form.instance.pk }}">
                            {% endif %}
                            
                            <div class="modal-footer py-3">
                                <button type="submit" class="btn btn-success px-4">
                                    {% if form.instance.pk %}Guardar Cambios{% else %}Agendar{% endif %}
                                </button>
                                <a href="{% url 'reception:consultation_list' %}" class="btn btn-secondary px-4">Cancelar</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para mostrar horarios del doctor -->
<div class="modal fade" id="modalHorariosDoctor" tabindex="-1" aria-labelledby="modalHorariosDoctorLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header  text-dark">
        <h5 class="modal-title" id="modalHorariosDoctorLabel">Horarios disponibles del doctor</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="modalHorariosDoctorBody">
        <!-- Aquí se cargará la tabla de horarios vía AJAX -->
        <div class="text-center text-muted">Seleccione un doctor y haga clic en "Ver horarios".</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>


<script>
function verHorariosDoctor() {
    var doctorId = document.getElementById('id_doctor').value;
    var fecha = document.getElementById('id_date').value; // <-- obtiene la fecha seleccionada
    var consultaIdEl = document.getElementById('consulta_id');
    var consultaId = consultaIdEl ? consultaIdEl.value : '';
    if (!doctorId) {
        alert('Selecciona un doctor primero.');
        return;
    }
    if (!fecha) {
        alert('Selecciona una fecha primero.');
        return;
    }
    // Llama a la vista por AJAX y pasa la fecha como parámetro GET
    fetch(`/reception/doctor-schedule/${doctorId}/?fecha=${fecha}` + (consultaId ? `&consulta_id=${consultaId}` : ''))
        .then(response => response.text())
        .then(html => {
            document.getElementById('modalHorariosDoctorBody').innerHTML = html;
            var modal = new bootstrap.Modal(document.getElementById('modalHorariosDoctor'));
            modal.show();
        })
        .catch(error => {
            document.getElementById('modalHorariosDoctorBody').innerHTML = '<div class="text-danger">No se pudieron cargar los horarios.</div>';
        });
}


function seleccionarHorario(dia, inicio, fin, consultorio) {
    document.getElementById('horarioSeleccionadoInfo').innerHTML =
        `<strong>Día:</strong> ${dia} &nbsp; <strong>Inicio:</strong> ${inicio} &nbsp; <strong>Fin:</strong> ${fin} &nbsp; <strong>Consultorio:</strong> ${consultorio}`;

    // Asigna la hora de inicio al campo oculto
    var inputHora = document.getElementById('hora_consulta');
    if (inputHora) {
        inputHora.value = inicio;
    }
    
    // Determina el turno según la hora de inicio
    var turno = "";
    var hora = parseInt(inicio.split(":")[0]);
    if (hora >= 8 && hora < 12) {
        turno = "MAÑANA";
    } else if (hora >= 12 && hora < 18) {
        turno = "TARDE";
    } else if (hora >= 18 && hora < 21) {
        turno = "NOCHE";
    }

    // Selecciona el turno en el select
    var selectTurno = document.getElementById('id_shift');
    if (selectTurno) {
        selectTurno.value = turno;
    }

    // Si usas el campo oculto
    var inputTurno = document.getElementById('turno_auto');
    if (inputTurno) {
        inputTurno.value = turno;
    }

    var modal = bootstrap.Modal.getInstance(document.getElementById('modalHorariosDoctor'));
    modal.hide();
}


document.addEventListener('DOMContentLoaded', function() {
    var selectDoctor = document.getElementById('id_doctor');
    var diasDoctorDiv = document.getElementById('diasDoctor');
    if (selectDoctor && diasDoctorDiv) {
        selectDoctor.addEventListener('change', function() {
            var doctorId = selectDoctor.value;
            if (!doctorId) {
                diasDoctorDiv.innerHTML = "Seleccione un doctor para ver los días de atención.";
                return;
            }
            fetch(`/reception/doctor-days/${doctorId}/`) 
                .then(response => response.json())
                .then(data => {
                    if (data.dias && data.dias.length > 0) {
                        diasDoctorDiv.innerHTML = "<strong>Días:</strong> " + data.dias.join(", ");
                    } else {
                        diasDoctorDiv.innerHTML = "Este doctor no tiene días de atención registrados.";
                    }
                })
                .catch(() => {
                    diasDoctorDiv.innerHTML = "No se pudieron cargar los días de atención.";
                });
        });
        // Dispara el evento al cargar si ya hay un doctor seleccionado
        if (selectDoctor.value) {
            selectDoctor.dispatchEvent(new Event('change'));
        }
    }


// Prefill al editar: mostrar horario guardado y setear campos ocultos
var isEditing = {{ form.instance.pk|yesno:"true,false" }};
if (isEditing) {
    var existingDate = "{{ form.instance.date|date:'Y-m-d' }}";
    var existingTime = "{{ form.instance.time|time:'H:i' }}";
    var existingShift = "{{ form.instance.shift }}";
    var existingConsultorio = "{{ form.instance.consultorio }}";
    var dateInput = document.getElementById('id_date');
    if (dateInput && !dateInput.value) { dateInput.value = existingDate; }
    var horaInput = document.getElementById('hora_consulta');
    if (horaInput) { horaInput.value = existingTime; }
    var turnoInput = document.getElementById('turno_auto');
    if (turnoInput) { turnoInput.value = existingShift; }
    var selectTurno = document.getElementById('id_shift');
    if (selectTurno) { selectTurno.value = existingShift; }
    var info = document.getElementById('horarioSeleccionadoInfo');
    if (info) {
        info.innerHTML = `<strong>Fecha:</strong> ${existingDate} &nbsp; <strong>Hora:</strong> ${existingTime} &nbsp; <strong>Consultorio:</strong> ${existingConsultorio}`;
    }
   }
   
});

</script>
</main>
{% endblock %}